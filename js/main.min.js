function Canvas(a,b){this.$elem=$(a);this.options=$.extend(this.defaults,b);this.brush=this.options.brush;this.mouse={down:!1,x:[],y:[]};this.addTopBar();this.addResizer();this.addCanvases();this.addControls();this.resizeCanvases();this.build()}
Canvas.prototype={defaults:{width:594,height:297,headerHeight:50,resizerHeight:16,cpHeight:65,topbarHeight:16,brush:{size:6,minSize:0.051,maxSize:32,opacity:0.75,minOpacity:0.01,maxOpacity:1,color:"51,102,153"},controls:{space:16}},koef:1,hstorage:[],checkPoint:"",backBlocked:!1,backQueue:0,blockResize:!1,fsEnabled:!1,addTopBar:function(){this.cleanBtn=$("<a/>",{"class":"cleanBtn",title:"\u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c",text:"\u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c"});this.cancelBtn=
$("<a/>",{"class":"cancelBtn",title:"\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c",text:"\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c"});this.saveBtn=$("<a/>",{"class":"saveBtn",title:"\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c",text:"\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c"});this.fullBtn=$("<a/>",{"class":"fullBtn",title:"\u0423\u0432\u0435\u043b\u0438\u0447\u0438\u0442\u044c",text:"\u0423\u0432\u0435\u043b\u0438\u0447\u0438\u0442\u044c"});this.cleanBtn.on("mousedown",
$.proxy(this.clean,this));this.cancelBtn.on("mousedown",$.proxy(this.backHistory,this));this.fullBtn.on("mousedown",$.proxy(this.fullScreen,this));this.saveBtn.on("mousedown",$.proxy(this.save,this))},addCanvases:function(){var a=this.options;this.$canvas=createCanvas(a.width,a.height);this.ctx=this.$canvas[0].getContext("2d");this.$fake=this.$canvas.clone();this.fakeCtx=this.$fake[0].getContext("2d");this.$hist=this.$canvas.clone();this.histCtx=this.$hist[0].getContext("2d");this.$fake.on("mousedown click",
$.proxy(this.handleDrawEvents,this));$(window).on("mousemove mouseup",$.proxy(this.handleDrawEvents,this))},addResizer:function(){this.$resizer=$("<div/>",{"class":"resizer"});this.$resizer.on("mousedown",$.proxy(this.handleResizeEvents,this));$(window).on("mousemove mouseup",$.proxy(this.handleResizeEvents,this))},addControls:function(){var a=this,b=this.options,c=b.brush,d=createCanvas(b.width,b.cpHeight),e=d[0].getContext("2d");e.fillStyle="rgb(225,225,225)";e.strokeStyle="rgb(125,125,125)";e.lineWidth=
0.5;e.save();a.$cp=d;a.$cpCtx=e;var g=b.controls.space,f={x:g,y:b.cpHeight/2},h=function(){e.save();e.clearRect(g-2,0,2*c.maxSize+4,2*c.maxSize+2);e.fillStyle="rgba("+c.color+", "+c.opacity+")";e.beginPath();e.arc(g+c.maxSize,f.y,normalizeXY(c.size),0,2*Math.PI,!1);e.fill();e.closePath();e.restore()};h();f.x+=2*c.maxSize+2*g;f.x+=addTitle(e,"\u0426\u0432\u0435\u0442:",f)+10;b=new ColorPicker(d,e,f,{onChange:function(b){a.brush.color=b;h()}});f.x+=b.position.w+3*g;a.$paletteCanvas=b.$palette;a.$paletteCtx=
b.$paletteCtx;f.x+=addTitle(e,"\u0422\u043e\u043b\u0449\u0438\u043d\u0430:",f)+10;b=new Scroll(d,e,f,{onChange:function(b){a.brush.size=(c.maxSize-c.minSize)/100*b+c.minSize;h()}});f.x+=b.position.w+g;f.x+=addTitle(e,"\u0418\u043d\u0442\u0435\u043d\u0441\u0438\u0432\u043d\u043e\u0441\u0442\u044c:",f)+10;d=new Scroll(d,e,f,{onChange:function(b){a.brush.opacity=(c.maxOpacity-c.minOpacity)/100*b+c.minOpacity;h()}});f.x+=d.position.w+g},build:function(){var a=this.options;this.$elem.append($("<header/>").append($("<h3/>",
{"class":"title",text:"\u0412\u0430\u0448\u0435 \u0433\u0440\u0430\u0444\u0444\u0438\u0442\u0438 \u043d\u0430  \u0441\u0442\u0435\u043d\u0443 Mr Jesus"})),$("<div/>",{"class":"topbar"}).append($("<div/>",{"class":"fl_l"}).append(this.cleanBtn,"<span> | </span>",this.cancelBtn),$("<div/>",{"class":"fl_r"}).append(this.saveBtn,"<span> | </span>",this.fullBtn)),$("<div/>",{"class":"canvas_wrap"}).append($("<div/>",{"class":"canvas_aligner",width:a.width,height:a.height}).append(this.$canvas.addClass("main"),
this.$fake.addClass("fake"),this.$hist.addClass("hist")),this.$resizer),$("<div/>",{"class":"toolbar",width:a.width,height:a.cpHeight}).append(this.$cp.addClass("cp"),$("<div/>",{"class":"palette_wrap"}).append(this.$paletteCanvas.addClass("palette"))));a=this.$canvas.offset();this.position={x:a.left,y:a.top,w:this.$canvas.width(),h:this.$canvas.height()}},handleResizeEvents:function(a){var b=this.options;switch(a.type){case "mousedown":$("body").css("cursor","s-resize");this.resizing=!0;this.lastCordY=
a.pageY;this.ctx.clearRect(0,0,b.width,b.height);break;case "mousemove":if(!this.resizing)break;var b=this.options,c=this.$canvas.parent(),d=parseInt(c.height());a=a.pageY;d=d+a-this.lastCordY;600<d&&(d=600);297>d&&(d=297);this.resH=d;var e=d/b.height*b.width;this.resW=e;c.width(e).height(d);this.$elem.height(b.headerHeight+b.topbarHeight+d+b.resizerHeight+b.cpHeight+40).width(e+32);this.onResize&&this.onResize(e,d);this.lastCordY=a;break;case "mouseup":if(!this.resizing)break;$("body").css("cursor",
"default");this.resizing=!1;this.lastCordY=0;this.koef=this.resH/297;this.options.width=this.resW;this.options.height=this.resH;this.resizeCanvases();this.copyImage(this.ctx)}},resizeCanvases:function(a){var b=this.options;a||this.$elem.height(b.headerHeight+b.topbarHeight+b.height+b.resizerHeight+b.cpHeight+40).width(b.width+32);this.$canvas.parent().find("canvas").attr("width",b.width).attr("height",b.height)},fullScreen:function(){var a=this,b=a.options;if(!a.mouse.down&&!a.blockResize)if(a.fsEnabled)a.fsEnabled=
!1,a.blockResize=!0,a.options.width=a.resW||594,a.options.height=a.resH||297,a.koef=a.options.height/297,a.$canvas.hide(),a.$elem.animate({width:b.width+32,height:b.headerHeight+b.topbarHeight+b.height+b.resizerHeight+b.cpHeight+40},400,function(){$(this).removeClass("full");a.fullBtn.text("\u0423\u0432\u0435\u043b\u0438\u0447\u0438\u0442\u044c").attr("title","\u0423\u0432\u0435\u043b\u0438\u0447\u0438\u0442\u044c");a.resizeCanvases(!0);a.copyImage(a.ctx);a.blockResize=!1;a.$canvas.fadeIn(300)}),
a.$elem.find("header").slideDown(400),a.$resizer.slideDown(400),a.$canvas.parent().animate({width:b.width,height:b.height},400);else{a.fsEnabled=!0;a.blockResize=!0;var b=window.innerWidth-40,c=Math.min(0.5*b,window.innerHeight-133),b=2*c;a.options.width=b;a.options.height=c;a.koef=c/297;a.$canvas.hide();this.$elem.animate({width:window.innerWidth-2,height:"100%"},400,function(){$(this).addClass("full");a.fullBtn.text("\u0423\u043c\u0435\u043d\u044c\u0448\u0438\u0442\u044c").attr("title","\u0423\u043c\u0435\u043d\u044c\u0448\u0438\u0442\u044c");
a.resizeCanvases(!0);a.copyImage(a.ctx);a.blockResize=!1;a.$canvas.fadeIn(300)});a.$elem.find("header").slideUp(400);a.$resizer.slideUp(400);a.$canvas.parent().animate({width:b,height:c},400)}},copyImage:function(a,b){this.drawHistory();b&&b()},handleDrawEvents:function(a){var b=getMouseXY(this.$canvas,a),c=this.options;switch(a.type){case "mousedown":this.down=!0;this.mouse.x=[b.x];this.mouse.y=[b.y];this.draw(this.fakeCtx);break;case "mousemove":if(!this.down)break;if(this.mouse.x==b.x&&this.mouse.y==
b.y)break;this.fakeCtx.clearRect(0,0,c.width,c.height);this.mouse.x.push(b.x);this.mouse.y.push(b.y);this.draw(this.fakeCtx);break;case "mouseup":if(!this.down)break;this.down=!1;this.fakeCtx.clearRect(0,0,c.width,c.height);this.draw(this.ctx);this.pushHistory({mouse:{x:this.mouse.x,y:this.mouse.y},color:this.brush.color,size:this.brush.size*this.koef,opacity:this.brush.opacity,koef:this.koef});this.mouse.x=[];this.mouse.y=[]}},draw:function(a,b){var c,d,e,g;b?(c=b.mouse,d=b.color,g=b.opacity,e=b.size):
(c=this.mouse,d=this.brush.color,e=this.brush.size*this.koef,g=this.brush.opacity);var f=c.x;c=c.y;var h=f.length;a.strokeStyle="rgba("+d+", "+g+")";a.lineWidth=2*e;a.lineCap="round";a.lineJoin="round";a.beginPath();a.moveTo(f[0],c[0]);if(2>h)a.lineTo(f[0]+0.51,c[0]);else{a.lineTo(0.5*(f[0]+f[1]),0.5*(c[0]+c[1]));d=0;e=Math.abs;for(var j;++d<h-1;)g=e(f[d-1]-f[d])+e(c[d-1]-c[d])+e(f[d]-f[d+1])+e(c[d]-c[d+1]),j=e(f[d-1]-f[d+1])+e(c[d-1]-c[d+1]),10<g&&j>0.8*g?a.quadraticCurveTo(f[d],c[d],0.5*(f[d]+f[d+
1]),0.5*(c[d]+c[d+1])):(a.lineTo(f[d],c[d]),a.lineTo(0.5*(f[d]+f[d+1]),0.5*(c[d]+c[d+1])));a.lineTo(f[h-1],c[h-1]);a.moveTo(f[h-1],c[h-1])}a.stroke();a.closePath()},pushHistory:function(a){this.hstorage.push(a);this.histCtx.clearRect(0,0,this.options.width,this.options.height);this.drawHistory()},backHistory:function(){var a=this,b=a.options;if(0===a.hstorage.length){a.backQueue=0;if(""==a.checkPoint)return!1;a.hstorage=[];a.checkPoint=""}else if(a.backBlocked)a.backQueue++;else if(a.backBlocked=
!0,""!=a.checkPoint)$("<img/>",{src:thmeis.checkPoint}).on("load",function(){a.$hist.fadeIn(200,function(){a.ctx.clearRect(0,0,b.width,b.height);a.ctx.drawImage(this,0,0,b.width,b.height);a.redrawHistory()})});else a.ctx.clearRect(0,0,b.width,b.height),a.redrawHistory()},drawHistory:function(){for(var a=this,b=a.hstorage,c=b.length,d=[],e=[],g,f,h=0;h<c-1;h++){var j=b[h];if(!j)return;f=j.koef;g=j.size/f*a.koef;for(var k=0;k<j.mouse.x.length;k++)d.push(j.mouse.x[k]/f*a.koef),e.push(j.mouse.y[k]/f*
a.koef);a.draw(a.histCtx,{mouse:{x:d,y:e},size:g,color:j.color,opacity:j.opacity});d=[];e=[]}a.checkPoint=a.$hist[0].toDataURL();$("<img/>",{src:a.checkPoint}).on("load",function(){a.ctx.clearRect(0,0,a.options.width,a.options.height);a.ctx.drawImage(this,0,0,a.options.width,a.options.height);a.propDraw(a.ctx,a.hstorage,c-1,c)})},redrawHistory:function(){var a=this;a.$hist.fadeOut(0,function(){a.histCtx.clearRect(0,0,a.options.width,a.options.height);a.propDraw(a.histCtx,a.hstorage,0,a.hstorage.length-
2);a.checkPoint=a.$hist[0].toDataURL();a.backBlocked=!1;if(0<a.backQueue)for(var b=0;b<a.backQueue;b++)a.backHistory(),a.backQueue--;a.hstorage.pop()})},propDraw:function(a,b,c,d){for(var e=[],g=[],f,h,j=c;j<d;j++){f=b[j];if(!f)break;h=f.koef;c=f.size/h*this.koef;for(var k=0;k<f.mouse.x.length;k++)e.push(f.mouse.x[k]/h*this.koef),g.push(f.mouse.y[k]/h*this.koef);this.draw(a,{mouse:{x:e,y:g},size:c,color:f.color,opacity:f.opacity});e=[];g=[]}},clean:function(){var a=this.options;this.hstorage=[];this.checkPoint=
"";$.each([this.ctx,this.fakeCtx],function(b,c){c.clearRect(0,0,a.width,a.height)})},save:function(){window.open(this.$canvas[0].toDataURL(),"","width="+this.options.width+",height="+this.options.height)}};
var CanvasModule=function(a,b,c,d){a.$canvas=b;a.ctx=c||b[0].getContext("2d");a.addTitle=function(b,d){d=normalizeXY(d||this.position);a.ctx.fillText(b,d.x,d.y);return c.measureText(b).width};a.setPositionProps=function(b,c){a.position={x:d.x,y:d.y,w:b,h:c,sx:normalizeXY(d.x),sy:normalizeXY(d.y-c/2),ex:normalizeXY(d.x+b),ey:normalizeXY(d.y+c/2)}};a.getMouse=function(b){var c=a.position,d=getMouseXY(a.$canvas,b);b=d.x;d=d.y;return{isOver:!(b<c.x||b>c.ex||d<c.sy||d>c.ey),x:b,y:d}};return a},ColorPicker=
function(a,b,c,d){a=new CanvasModule(this,a,b,c);d=a.options=$.extend(d,a.defaults);a.setPositionProps(d.trW,d.trH+d.spaceH+d.cbSize);a.createPalette();a.drawTriangle();a.setValue(d.value);$(window).on({mousedown:$.proxy(a._onMouseDown,a)});return a};
ColorPicker.prototype={defaults:{value:"51,102,153",cbSize:14,blMargin:0.5,colorStep:51,trW:16,trH:6,spaceH:3},createPalette:function(){for(var a=this,b=a.options,c=createCanvas(18*b.cbSize+2*b.blMargin,12*b.cbSize+2*b.blMargin),d=c[0].getContext("2d"),e=b.cbSize,g=b.colorStep,f=b.blMargin,h,j,k=0;6>k;k++)for(var l=0;6>l;l++){j=e*l+f;2<k&&(j+=6*e);for(var n=0;6>n;n++)h=e*n+f,h+=2<k?6*e*(k-3):6*e*k,b=[g*k,g*n,g*l].join(", "),a.drawColorBlock(d,{x:h,y:j},b,"0,0,0")}var m=null;c.on({mousedown:function(b){b=
getMouseXY(c,b);a.setValue(a.getColor(b))},mousemove:function(b){b=getMouseXY(c,b);var g=a.getColor(b);if(!(b.x>=18*e||b.y>=12*e)){b.x-=b.x%e-f;b.y-=b.y%e-f;if(m){if(m.cords==b)return;a.drawColorBlock(d,m.cords,m.color,"0,0,0")}m={cords:b,color:g};a.drawColorBlock(d,b,g,"255,255,255")}}});a.$palette=c;a.paletteCtx=d},drawTriangle:function(a){var b=this.ctx,c=this.position,d=this.options,e=c.sy;b.clearRect(c.x,e,d.trW,d.trH);b.save();a&&(b.fillStyle="white");b.beginPath();b.moveTo(c.x+c.w/2,e);b.lineTo(c.ex,
e+d.trH);b.lineTo(c.x,e+d.trH);b.lineTo(c.x+c.w/2,e);b.fill();b.stroke();b.closePath();b.restore()},drawColorBlock:function(a,b,c,d){var e=this.options.cbSize;a.save();a.fillStyle="rgb("+c+")";a.strokeStyle="rgb("+d+")"||c;a.clearRect(b.x-0.5,b.y-0.5,e+1,e+1);c&&a.fillRect(b.x,b.y,e,e);d&&a.strokeRect(b.x,b.y,e,e);a.restore()},getColor:function(a){var b=this.options,c=b.cbSize,b=b.colorStep,d=(a.x-a.x%c)/c;a=(a.y-a.y%c)/c;c=(d-d%6)/6+(a-a%6)/2;return[b*c,b*(d-6*(c%3)),b*(a-6*((c-c%3)/3))].join()},
setValue:function(a){if(this.value!==a){var b=this.position,c=this.options;this.drawColorBlock(this.ctx,{x:b.x+(b.w-c.cbSize)/2,y:b.sy+c.trH+c.spaceH},a);this.value=a;this.options.onChange(a)}},_onMouseDown:function(a){a=this.getMouse(a);var b=this.$palette.parent(".palette_wrap");a.isOver?b.fadeToggle():b.fadeOut()}};
var Scroll=function(a,b,c,d){b=new CanvasModule(this,a,b,c);d=b.options=$.extend(d,b.defaults);b.setPositionProps(d.ordW,d.markH+d.spaceH+d.handlerH+4);a.on({mousedown:$.proxy(b._onMouseDown,b)});$(window).on({mousemove:$.proxy(b._onMouseMove,b),mouseup:$.proxy(b._onMouseUp,b)});b.drawStatic();b.setValue(d.value);return b};
Scroll.prototype={defaults:{value:75,marksCnt:10,markW:4,markH:6,spaceH:3,ordW:96,ordH:4,handlerW:6,handlerH:10},setValue:function(a){100<a?a=100:0>a&&(a=0);this.value!=a&&(this.value=a,this.drawDynamic(),this.options.onChange(a))},drawStatic:function(){var a=this.ctx,b=this.options,c=this.position,d=b.marksCnt,e=b.ordW/d,g=c.sy,b=g+b.markH,f=0,h=1;for(a.beginPath();h<d;h++)f=normalizeXY(c.x+e*h),a.moveTo(f,g),a.lineTo(f,b);a.stroke()},drawDynamic:function(){var a=this.ctx,b=this.options,c=this.position,
d=b.ordW,e=b.ordH,g=b.handlerW,f=b.handlerH,h=normalizeXY(c.x+(d-g)/100*this.value),j=c.sy+b.markH+b.spaceH,k=normalizeXY(c.x),l=j+(f-e)/2;a.clearRect(c.x-2,j-b.spaceH/2,c.w+4,c.h);a.fillRect(k,l,d,e);a.strokeRect(k,l,d,e);a.fillRect(h,j,g,f);a.strokeRect(h,j,g,f)},_onMouseDown:function(a){var b=this.position,c=getMouseXY(this.$canvas,a);a=c.x;c=c.y;a<b.x||(a>b.x+b.w||c<b.y-b.w||c>b.y+b.w)||(this.focused=!0,this.setValue(100*((a-b.x)/b.w)))},_onMouseMove:function(a){if(this.focused){var b=this.position;
a=getMouseXY(this.$canvas,a).x;var c=0,c=a<b.x?0:a>b.x+b.w?100:100*((a-b.x)/b.w);this.setValue(c)}},_onMouseUp:function(){this.focused=!1}};function createCanvas(a,b){return $("<canvas width="+a+" height="+b+"/>")}function addTitle(a,b,c){c=normalizeXY(c);a.save();a.font="11px Tahoma, Arial, Verdana, Sans-Serif, Lucida Sans";a.fillStyle="black";a.textBaseline="middle";a.beginPath();a.fillText(b,c.x,c.y);a.closePath();b=a.measureText(b).width;a.restore();return b}
function getMouseXY(a,b){var c=a.offset();return{x:b.pageX-c.left,y:b.pageY-c.top}}function normalizeXY(a){if($.isNumeric(a))return parseInt(a.toFixed(0))+0.5;var b=0,c=0;$.isArray(a)?(b=a[0],c=a[1]):a.x&&(b=a.x,c=a.y);return{x:parseInt(b.toFixed(0))+0.5,y:parseInt(c.toFixed(0))+0.5}}
function touchHandler(a){a=a.originalEvent;var b=a.changedTouches[0],c="";switch(a.type){case "touchstart":c="mousedown";break;case "touchmove":c="mousemove";break;case "touchend":c="mouseup";break;default:return}var d=document.createEvent("MouseEvent");d.initMouseEvent(c,!0,!0,window,1,b.screenX,b.screenY,b.clientX,b.clientY,!1,!1,!1,!1,0,null);b.target.dispatchEvent(d);a.preventDefault()}$(function(){new Canvas($(".graffit")[0])});
